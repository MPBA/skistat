<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Ski Connection Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/map.css">

    <!-- <link rel="stylesheet" href="../lib/bootstrap/css/bootstrap-responsive.css"> -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <link rel="stylesheet" href="lib/dvf/dvf.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="css/example.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="css/ui.css" type="text/css" media="screen" />
</head>

<body>
    <div id="container">
        <div id="map" style="width:100%; height:100%"></div>
        <div id="info" class="leaflet-control-legend" style="display:none"><span style="font-style: italic; font-size: 16px;"></span></div>
        <div id="info2" class="leaflet-control-legend" style="display:none"><span style="font-style: italic; font-size: 16px;"></span>
        </div>

        <svg id="mover_container">
            <rect  id="mover" 0="30" 0="30" width="400" height="20" fill="#0daffd" onmousedown="treeSelected(evt)"
          transform="matrix(1,0,0,1,0,0)">
            </rect>     
        </svg>

        <div id="mover_tip">
            <p>Drag to move the tree map</p>
        </div>

    </div>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="js/leaflet/TileLayer.Grayscale.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
    <script type="text/javascript" src="data/v2/lifts.js"></script>
    <script type="text/javascript" src="data/v2/connections.js"></script>
    <script type="text/javascript" src="data/v2/dati.js"></script>
    <script type="text/javascript" src="lib/dvf/dvf.js"></script>
    <script type="text/javascript" src="data/v2/dati_unique.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://d3js.org/d3.v3.js"></script>
    <script type="text/javascript" src="lib/dvf/tipsy.js"></script>
    <link rel="stylesheet" href="lib/dvf/tipsy.css" type="text/css" media="screen" />


    <script>
        google.charts.load('current', {
            packages: ['corechart', 'bar']
        });

        function drawBars(rows) {

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Time Slots');
            data.addColumn('number', 'Bips');

            data.addRows(rows);

            var options = {
                height: 250,
                legend: 'none',
                vAxis: {
                    title: 'Bips'
                },
                hAxis: {
                    title: "Hour range",
                    slantedText: true,
                    slantedTextAngle: 45
                },
                chartArea: {
                    top: 15,
                    bottom: 80,
                    width: '75%',
                    height: '34%'
                }
            };

            var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
            chart.draw(data, options);
        };

        function drawBars_label(rows) {

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Time Slots');
            data.addColumn('number', 'Bips');

            data.addRows(rows);

            var options = {
                height: 120,
                legend: 'none',
                hAxis: {
                    slantedText: true,
                    slantedTextAngle: 45
                },
                chartArea: {
                    top: 15,
                    bottom: 40,
                    width: '65%',
                    height: '80%'
                }
            };

            var chart = new google.visualization.ColumnChart(document.getElementById('legend_plot'));
            chart.draw(data, options);
        }


        function drawPie(rows) {

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Time Slots');
            data.addColumn('number', 'Bips');

            data.addRows(rows);

            var options = {
                height: 250,
                legend: 'labeled',
                sliceVisibilityThreshold: .05,
                chartArea: {
                    top: 15,
                    bottom: 80,
                    width: '75%',
                    height: '34%'
                }
            };

            var chart = new google.visualization.PieChart(document.getElementById('pie_div'));
            chart.draw(data, options);
        }
    </script>

    <script>
        var $info = $('#info');
        var $info2 = $('#info2');
        var selezionate = [];
        var selected;
        var indici_tree = 0;
        var blocked = false;
        var map = L.map('map').setView([46.34964, 11.54823], 13);
        var base_layer = L.tileLayer('https://api.mapbox.com/styles/v1/earbitrio/ciyk0od5a001u2skez1cmz44q/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZWFyYml0cmlvIiwiYSI6Img4M0xNM1EifQ.7fem5ojUeemskoY6LhLOBA', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            subdomains: ['a', 'b', 'c']
        }).addTo(map);

        var grey_layer = L.tileLayer('https://api.mapbox.com/styles/v1/earbitrio/ciykoji0t00482slafcwg8nxj/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZWFyYml0cmlvIiwiYSI6Img4M0xNM1EifQ.7fem5ojUeemskoY6LhLOBA', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">MapBox</a>',
            subdomains: ['a', 'b', 'c']
        }).addTo(map);

        var slopes_layer = L.tileLayer('http://tiles.opensnowmap.org/tiles-pistes/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.opensnowmap.org/copyright">OpenSnowMap</a>',
            subdomains: ['a', 'b', 'c'],
            opacity: 0.5
        }).addTo(map);
        var baseLayers = {
            "Base Layer": base_layer,
            "Grey Layer": grey_layer
        };

        var overlays = {
            "Slopes layer": slopes_layer
        };

        var layerControl = L.control.layers(baseLayers, overlays).addTo(map);


        var liftsLookup = L.GeometryUtils.arrayToMap(lifts, 'code');


        // Group connection data by cart type
        //var connectionLookup = _.groupBy(connections, function (value) {
        //	return value.cad_type;
        //});
        var searchWords = []
        for (var i = 0; i < connections.length; i++) {
            searchWords.push('-' + connections[i].source + '-' + connections[i].target + '-')
        }
        var tmp = '';
        var total_tmp = [];
        var total_tmp_unique = []

        var re = new RegExp(searchWords.join("|"), "g");
        //per simulare tanti dati mettere k<100
        for (var k = 0; k < 1; k++) {
            tmp = ''
            for (var i = 0; i < persone.length; i++) {

                tmp += persone[i].path

            }
            total_tmp.push(tmp)
        }
        var tmp_unique = ''
        for (var k = 0; k < 1; k++) {
            for (var i = 0; i < persone_unique.length; i++) {
                tmp_unique = ''
                tmp_unique += persone_unique[i].path

            }
            total_tmp_unique.push(tmp)
        }

        function matchOverlap(input, re) {
            var r = [],
                m;
            // prevent infinite loops
            if (!re.global) re = new RegExp(
                re.source, (re + '').split('/').pop() + 'g'
            );
            while (m = re.exec(input)) {
                re.lastIndex -= m[0].length - 1;
                r.push(m[0]);
            }
            return r;
        }


        // var tmp = tmp.match(re)
        var res = matchOverlap(tmp, re)

        var obj = {};
        for (var i = 0, j = res.length; i < j; i++) {
            obj[res[i]] = (obj[res[i]] || 0) + 1;
        }
        var m = 0
        for (var i = 0; i < connections.length; i++) {
            connections[i].cnt = obj['-' + connections[i].source + '-' + connections[i].target + '-']
            connections[i].logcnt = Math.log(obj['-' + connections[i].source + '-' + connections[i].target + '-'] + 1)

        }
        connections = _.sortBy(connections, function(value) {
            return -1 * value.cnt;
        });

        var maxCount = Number(connections[0].cnt);
        var lmaxCount = Number(connections[0].logcnt);

        var count = 0;

        // Get a lift location.  This function looks up an airport from a provided airport code
        var getLocation = function(context, locationField, fieldValues, callback) {
            var key = fieldValues[0];
            var lift = liftsLookup[key];
            var location;

            if (lift) {
                var latlng = new L.LatLng(Number(lift.lat), Number(lift.lon));
                location = {
                    location: latlng,
                    text: key,
                    center: latlng
                };
            }
            return location;
        };

        var sizeFunction = new L.LinearFunction([1, 16], [253, 48]);
        var options = {
            recordsField: null,
            locationMode: L.LocationModes.CUSTOM,
            fromField: 'source',
            toField: 'target',
            fromLabel: 'source-label',
            toLabel: 'target-label',
            chart_labels: 'label_ora',
            chart_data: 'passaggi',
            graph_fuction: drawBars_label,
            graph_div: 'legend_plot',
            codeField: null,
            getLocation: getLocation,
            getEdge: L.Graph.EDGESTYLE.ARC,
            includeLayer: function(record) {
                return false;
            },
            getIndexKey: function(location, record) {
                return record.source + '_' + record.target;
            },
            setHighlight: function(style) {
                style.opacity = 1.0;
                return style;
            },
            unsetHighlight: function(style) {
                style.opacity = 0.5;
                return style;
            },
            layerOptions: {
                fill: false,
                opacity: 0.5,
                weight: 0.5,
                fillOpacity: 1.0,
                distanceToHeight: new L.LinearFunction([0, 20], [1000, 300]),
                markers: {
                    end: true
                },
                // Use Q for quadratic and C for cubic
                mode: 'Q'
            },
            legendOptions: {
                width: 200,
                numSegments: 5,
                className: 'legend-line'
            },
            tooltipOptions: {
                iconSize: new L.Point(300, 250),
                iconAnchor: new L.Point(-5, 64),
                className: 'leaflet-div-icon line-legend'
            },
            displayOptions: {
                cnt: {
                    weight: new L.LinearFunction([0, 1], [maxCount, 10]),
                    color: new L.HSLHueFunction([0, 200], [maxCount, 330], {
                        outputLuminosity: '60%'
                    }),
                    displayName: 'count #'
                },
                logcnt: {
                    weight: new L.LinearFunction([0, 1], [lmaxCount, 10]),
                    color: new L.HSLHueFunction([0, 200], [lmaxCount, 330], {
                        outputLuminosity: '60%'
                    }),
                    displayName: 'log' //NON DEVE ESSERE CAMBIATO PERCHE' ALTRIMENTI AGGIUNGE A LEGENDA
                }
            },
            onEachRecord: function(layer, record) {
                layer.bindPopup($(L.HTMLUtils.buildTable(record)).wrap('<div/>').parent().html());
            }
        };
        var allLayer = new L.Graph(connections, options);
        map.addLayer(allLayer);


        var liftsLayer = new L.MarkerDataLayer(liftsLookup, {
            recordsField: null,
            locationMode: L.LocationModes.LATLNG,
            latitudeField: 'lat',
            longitudeField: 'lon',

            layerOptions: {
                fill: false,
                stroke: false,
                weight: 0,
                color: '#006cbf'
            },

            setIcon: function(record, options) {
                var html = '<div><i class="fa fa-map-marker" "id"=' + record.code + '></i><span class="code">' + record.code + '</span></div>';
                var $html = $(html);

                var $i = $html.find('i');
                L.StyleConverter.applySVGStyle($i.get(0), options);
                var size = 28; //dimensione fissa #TODO: size in base a una metrica decente

                $i.width(size);
                $i.height(size);
                $i.css('font-size', size + 'px');
                $i.css('line-height', size + 'px');

                var icon = new L.DivIcon({
                    iconSize: new L.Point(size, size),
                    iconAnchor: new L.Point(size / 2, size),
                    className: 'airport-icon',
                    html: $html.wrap('<div/>').parent().html()

                });
                return icon;
            },
            onEachRecord: function(layer, record) {
                layer.on('mouseover', function() {
                    $info.removeAttr('style');
                    $info.empty();
                    $info.append($(L.HTMLUtils.buildTable(record, className = '', ignoreFields = ['code', 'passaggi', 'label_ora'])).wrap('<div/>').parent().html());
                    $info.append($('<div id="chart_div"></div>'));
                    $info.append($('<div id="pie_div"></div>'));

                    var pie = []
                    for (var j = 0; j < connections.length; j++) {
                        if (connections[j].source == record.code)
                            pie.push([connections[j]['target-label'], connections[j].cnt])
                    }

                    var a = eval(record.label_ora);
                    var b = eval(record.passaggi);
                    var c = a.map(function(e, i) {
                        return [a[i], b[i]];
                    });

                    google.charts.setOnLoadCallback(drawBars(c));
                    google.charts.setOnLoadCallback(drawPie(pie));

                    allLayer.options.includeLayer = function(newRecord) {
                        return !blocked ? (newRecord.source === record.code) : false;
                    };
                    if (!blocked) allLayer.reloadData();
                });


            }
        });

        redraw_flow = function() {


            var root = selected;
            var path_generale = '-' + selected + '-';
            var root_info = $.grep(lifts, function(e) {
                return e.code == root;
            })[0];
            console.log(asd = lifts, root_info)
            var pas = eval(root_info.passaggi);
            var count = 0;
            for (var k = 0; k < pas.length; count += pas[k++]);



            var m = [20, 20, 20, 20],
                w = 1100 - m[1] - m[3],
                h = 260 - m[0] - m[2],
                i = 0,
                root;

            var nodeWidth = 300;
            var nodeHeight = 75;
            var horizontalSeparationBetweenNodes = 16;
            var verticalSeparationBetweenNodes = 128;

            var tree = d3.layout.tree() //.size([h, w]);
                .nodeSize([nodeWidth + horizontalSeparationBetweenNodes, nodeHeight + verticalSeparationBetweenNodes]);

            var diagonal = d3.svg.diagonal()
                .projection(function(d) {
                    return [d.y, d.x];
                });


            var vis = d3.select("#info2").append("svg:svg")
                .attr("width", w + m[1] + m[3])
                .attr("height", h + m[0] + m[2])
                .append("svg:g")
                .attr("transform", "translate(" + m[3] + "," + m[0] + ")")
                .attr("id", "tree"); // not in the working file





            root = {

                label: selected,
                text: root_info.name,
                count: count,
                path: '-' + selected,
                passaggi: count

            };
            root.x0 = w / 2;
            root.y0 = 0;

            function toggleAll(d) {
                if (d.children) {
                    d.children.forEach(toggleAll);
                    toggle(d);
                }
            }


            update(root);



            function addNewNode(d, item) {
                d._children = d._children || [];
                d._children = d._children.concat(item);
            }


            function update(source) {
                var duration = d3.event && d3.event.altKey ? 5000 : 500;

                // Compute the new tree layout.
                var nodes = tree.nodes(root).reverse();

                // Normalize for fixed-depth.
                nodes.forEach(function(d) {
                    d.y = d.depth * 180;
                    // d.x = d.depth * 200;

                });
                tree = tree.size([h, w]);

                // Update the nodes…
                var node = vis.selectAll("g.node")
                    .data(nodes, function(d) {
                        return d.id || (d.id = ++i);
                    });



                // Enter any new nodes at the parent's previous position.
                var nodeEnter = node.enter().append("svg:g")
                    .attr("class", "node")
                    .attr("transform", function(d) {
                        return "translate(" + source.y0 + "," + source.x0 + ")";
                    })
                    .on("click", function(d) {



                        var newItem = [];

                        for (var j = 0; j < connections.length; j++) {
                            if (connections[j].source == d.label) {

                                //conto quanti passaggi ha source--target
                                count = 0
                                for (var k = 0; k < 1; k++)
                                    count += matchOverlap(total_tmp_unique[k], new RegExp((d.path + '-' + connections[j].target + '-'), "g")).length;
                                var nodo_attuale = $.grep(lifts, function(e) {
                                    return e.code == connections[j].target;
                                })[0];
                                var pas = eval(nodo_attuale.passaggi);
                                var count_passaggi = 0;
                                for (var k = 0; k < pas.length; count_passaggi += pas[k++]);
                                if ((!d._children || d._children.length === 0) && count > 0) {
                                    newItem.push({
                                        label: connections[j].target,
                                        text: connections[j]['target-label'],
                                        count: count,
                                        path: d.path + '-' + connections[j].target,
                                        passaggi: count_passaggi
                                    })

                                }
                            }




                        }

                        addNewNode(d, newItem);
                        toggle(d);
                        update(d);

                        $('svg circle').tipsy({
                            gravity: 'sw',
                            html: true,
                            title: function() {

                                var d = this.__data__;
                                return d.text + "<br>" + d.count + " bips <br> su un totale di:" + d.passaggi;
                            }
                        })

                        allLayer.options.includeLayer = function(newRecord) {
                            console.log(d.path)
                            return matchOverlap(d.path, new RegExp(newRecord.source + '-' + newRecord.target, "g")).length > 0;;
                        };
                        allLayer.reloadData();

                        //onclick on a node, all the nodes and links which were given a specific id are coloured differently
                        while (d.parent) {
                            d3.selectAll("#node" + d.id).style("fill", "#0daffd"); //color the node

                            if (d.parent != "null") {
                                d3.selectAll("#link" + d.parent.id + "-" + d.id).style("stroke", "#0daffd"); //color the path
                            }

                            d = d.parent;
                        }



                        var svg_coso = $('#info2 svg')[0];
                        var svg_tree = $(svg_coso)[0].firstChild;
                        svg_tree_width = svg_tree.getBBox().width;

                        if (svg_tree_width > 200) {

                            $('#mover_container').css({
                                display: "block"
                            })

                            //larghezza mover = to the one of the tree map
                            $('#mover').animate({
                                "width": svg_tree_width.toString()
                            }, 1000, function() {})


                        } else {
                            $('#mover_container').css({
                                display: "none"
                            })
                        }

                        svg_tree_height = svg_tree.getBBox().height;

                        if (svg_tree_height > 200) {
                            //take #info2 and make it expandable
                        }

                    });


                nodeEnter.append("svg:circle")
                    .attr("r", 1e-6)
                    .attr("id", function(d) {
                        return "node" + d.id;
                    })
                    .style("fill", function(d) {
                        return d._children ? "#ccc" : "#ccc";
                    });

                nodeEnter.append("svg:text")
                    .attr("x", function(d) {
                        return d.children || d._children ? -10 : 10;
                    })
                    .attr("dy", ".35em")
                    .attr("text-anchor", function(d) {
                        return d.children || d._children ? "end" : "start";
                    })
                    .text(function(d) {
                        return d.label;
                    })
                    .style("fill-opacity", 1e-6);

                // Transition nodes to their new position.
                var nodeUpdate = node.transition()
                    .duration(duration)
                    .attr("transform", function(d) {
                        return "translate(" + d.y + "," + d.x + ")";
                    });

                nodeUpdate.select("circle")
                    .attr("r", function(d) {
                        return Math.log(d.passaggi + 1);
                    })
                    .style("fill", function(d) {
                        return d.children ? "#0daffd" : "#ccc";
                    })
                    .style("stroke", function(d) {
                        return d.children ? "#0daffd" : "#ccc";
                    });

                nodeUpdate.select("text")
                    .style("fill-opacity", 1);

                // Transition exiting nodes to the parent's new position.
                var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function(d) {
                        return "translate(" + source.y + "," + source.x + ")";
                    })
                    .remove();

                nodeExit.select("circle")
                    .attr("r", 1e-6);

                nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

                // Update the links…
                var link = vis.selectAll("path.link")
                    .data(tree.links(nodes), function(d) {
                        return d.target.id;
                    });

                // Enter any new links at the parent's previous position.
                link.enter().insert("svg:path", "g")
                    .attr("class", "link")
                    .attr("stroke-width", function(d) {
                        //  console.log(d.target.count)
                        return Math.log(d.target.count * 10);
                    })
                    .attr("d", function(d) {
                        var o = {
                            x: source.x0,
                            y: source.y0
                        };
                        return diagonal({
                            source: o,
                            target: o
                        });
                    })
                    .attr("id", function(d) {
                        return ("link" + d.source.id + "-" + d.target.id);
                    })
                    .transition()


                .duration(duration)
                    .attr("d", diagonal);

                // Transition links to their new position.
                link.transition()
                    .duration(duration)
                    .attr("d", diagonal);

                // Transition exiting nodes to the parent's new position.
                link.exit().transition()
                    .duration(duration)
                    .attr("d", function(d) {
                        var o = {
                            x: source.x,
                            y: source.y
                        };
                        return diagonal({
                            source: o,
                            target: o
                        });
                    })
                    .remove();

                // Stash the old positions for transition.
                nodes.forEach(function(d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });

            }



            function toggle(d) {
                //collapse the branch if it has children
                if (d.children) {
                    collapse(d);

                } else {
                    d.children = d._children;
                    d._children = null;
                }
                // If the node has a parent, then collapse its child nodes
                // except for this clicked node.
                if (d.parent) {
                    d.parent.children.forEach(function(element) {
                        if (d !== element) {
                            //resetting the color of the other paths so only the clicked one is blue
                            vis.selectAll("path.link").style("stroke", "#ccc");
                            collapse(element);
                        }
                    });
                }
                update(d);
            }


            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }



        }
        $('#map').on('click', function(e) {


            if (!e.ctrlKey) {


                blocked = false
                $('#info').attr('style', 'display:none');
                $('#info2').attr('style', 'display:none');
                allLayer.options.includeLayer = function(newRecord) {
                    return newRecord.source == null
                };
                allLayer.reloadData();

                options.displayOptions.logcnt.weight = new L.LinearFunction([0, 1], [lmaxCount, 10])
                options.displayOptions.logcnt.color = new L.HSLHueFunction([0, 200], [lmaxCount, 330])
                allLayer = new L.Graph(connections, options);
                map.addLayer(allLayer);

                allLayer.reloadData();
            } else {
                //devo bloccare l'hover su pin
                blocked = true
                allLayer.options.includeLayer = function(newRecord) {
                    return newRecord.source == null
                };
                allLayer.reloadData();

                $info2.removeAttr('style');
                $info2.empty();
                selected = Number(e.target.attributes[1].nodeValue)
                options.displayOptions.logcnt.weight = new L.LinearFunction([0, 4], [lmaxCount, 4])
                options.displayOptions.logcnt.color = new L.HSLHueFunction([0, 200], [lmaxCount, 200])

                allLayer = new L.Graph(connections, options);
                map.addLayer(allLayer);

                redraw_flow()
            }
        });
        map.addLayer(liftsLayer);
        layerControl.addOverlay(liftsLayer, 'Lifts');
    </script>


    <script>
        var selectedElement = 0;
        var currentX = 0;
        var currentY = 0;
        var currentMatrix = 0;
        var mover = document.getElementById('mover');
        var mover_container = document.getElementById('mover_container');
        var svg_tree_height;
        var svg_tree_width = 200;

        $('#mover_container').css({
            display: "none"
        })

        $('#mover').on('mousedown', function(e) {
            treeSelected(e);
        });

        function treeSelected(evt) {

            var svg_coso = $('#info2 svg')[0];
            var svg_tree = $(svg_coso)[0].firstChild;

            selectedElement = svg_tree;
            currentX = evt.clientX;
            currentY = evt.clientY;
            selectedElement.setAttributeNS(null, "transform", "matrix(1,0,0,1,0,0)");
            currentMatrix = selectedElement.getAttributeNS(null, "transform").slice(7, -1).split(',');

            for (var i = 0; i < currentMatrix.length; i++) {
                currentMatrix[i] = parseFloat(currentMatrix[i]);
            }

            mover.setAttributeNS(null, "onmousemove", "moveTree(evt)");
            mover.setAttributeNS(null, "onmouseup", "deselectTree(evt)");
            mover.setAttributeNS(null, "onmouseout", "deselectTree(evt)");
        }

        function moveTree(evt) {
            var clientX = evt.clientX;
            var clientY = evt.clientY;

            var dx = clientX - currentX;
            var dy = clientY - currentY;

            currentMatrix[4] += dx * 1.2;
            currentMatrix[5] += 0;
            var newMatrix = "matrix(" + currentMatrix.join(",") + ")";
            selectedElement.setAttributeNS(null, "transform", newMatrix);

            currentX = evt.clientX;
            currentY = evt.clientY;
        }

        function deselectTree(evt) {
            if (selectedElement != 0) {
                mover.removeAttributeNS(null, "onmousemove");
                mover.removeAttributeNS(null, "onmouseout");
                mover.removeAttributeNS(null, "onmouseup");
                selectedElement = 0;
            }
        }
    </script>

    <script>
        //when the mover is hovered show its tip, hide it when it's not
        $("#mover").mouseover(function(e) {
            $(document).mousemove(function(e) {
                $("#mover_tip").css({
                    "left": e.pageX,
                    "bottom": "30px",
                    "opacity": "1"
                });
            });
        });

        $("#mover").mouseout(function(e) {
            $(document).mousemove(function(e) {
                $("#mover_tip").css({
                    "opacity": "0"
                });
            });
        })
    </script> $(document).mousemove(function(e) { $("#mover_tip").css({ "opacity": "0" }); }); })
    </script>

</body>

</html>